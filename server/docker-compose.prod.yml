# Production Docker Compose configuration
# This configuration includes additional security and production best practices

version: "3.8"

services:
  mattstash-api:
    build:
      context: .
      dockerfile: Dockerfile.multistage
    image: mattstash-api:latest
    container_name: mattstash-api
    
    # Environment configuration
    environment:
      - MATTSTASH_DB_PATH=/data/mattstash.kdbx
      - MATTSTASH_API_KEYS_FILE=/secrets/api_keys.txt
      - KDBX_PASSWORD_FILE=/secrets/kdbx_password.txt
      - MATTSTASH_LOG_LEVEL=warning  # Less verbose in production
      - MATTSTASH_RATE_LIMIT=100/minute
    
    # Read-only volumes for security
    volumes:
      - ./data:/data:ro
      - ./secrets:/secrets:ro
    
    # Network isolation
    networks:
      - internal
    
    # Only expose on localhost by default
    # Use a reverse proxy (nginx/traefik) for external access with TLS
    ports:
      - "127.0.0.1:8000:8000"
    
    # Restart policy
    restart: unless-stopped
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 512M
        reservations:
          cpus: '0.5'
          memory: 256M
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Read-only root filesystem (except /tmp)
    read_only: true
    tmpfs:
      - /tmp
    
    # Health check
    healthcheck:
      test: ["CMD", "python", "-c", "import urllib.request; urllib.request.urlopen('http://localhost:8000/health')"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 10s
  
  # Optional: Nginx reverse proxy with TLS
  # Uncomment to enable HTTPS access
  # nginx:
  #   image: nginx:alpine
  #   container_name: mattstash-nginx
  #   volumes:
  #     - ./nginx.conf:/etc/nginx/nginx.conf:ro
  #     - ./certs:/etc/nginx/certs:ro
  #   ports:
  #     - "443:443"
  #   networks:
  #     - internal
  #   depends_on:
  #     - mattstash-api
  #   restart: unless-stopped

networks:
  internal:
    driver: bridge
    # Network isolation - no external access by default
    internal: false
